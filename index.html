<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Property Quotation Calculator</title>

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Frosted Mint Mockup — Pop Outputs</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-grad: linear-gradient(135deg, #fafafa, #fef9fb);
    --accent:#8b5cf6;
    --accent-alt:#ec4899;
    --text:#1f2937;
    --muted:#6b7280;
    --card-odd:#f5f3ff;
    --card-even:#fdf2f8;
    --card-bg:#fff;
    --v-bg:#fff;
    --v-color:#111827;
    --mini-bg:#f9fafb;
  }
  body.dark{
    --bg-grad: linear-gradient(135deg, #111827, #1f2937);
    --text:#f9fafb;
    --muted:#9ca3af;
    --card-odd:rgba(139,92,246,0.15);
    --card-even:rgba(236,72,153,0.15);
    --card-bg:rgba(31,41,55,0.6);
    --v-bg:rgba(255,255,255,0.1);
    --v-color:#f9fafb;
    --mini-bg:rgba(31,41,55,0.8);
  }
  *{box-sizing:border-box}
  html,body{
    height:100%;
    margin:0;
    font-family:'Poppins',system-ui,Arial;
    background:var(--bg-grad);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    position:relative;
    overflow-x:hidden;
    transition: background 0.5s ease, color 0.5s ease;
  }
  /* blobs and grid remain same (parallax + animated) */
  body::before, body::after{
    content:"";
    position:absolute;
    width:300px;
    height:300px;
    border-radius:50%;
    opacity:0.18;
    filter:blur(100px);
    z-index:0;
    animation: floatBlob 20s ease-in-out infinite alternate;
    transform: translate(var(--parallax-x), var(--parallax-y));
  }
  body::before{
    top:-120px;
    left:-100px;
    background:#c4b5fd;
    animation-delay:0s;
  }
  body::after{
    bottom:-120px;
    right:-100px;
    background:#f9a8d4;
    animation-delay:5s;
  }
  @keyframes floatBlob{
    0%{transform:translate(var(--parallax-x), var(--parallax-y)) scale(1);}
    50%{transform:translate(calc(var(--parallax-x) + 60px), calc(var(--parallax-y) + 40px)) scale(1.1);}
    100%{transform:translate(calc(var(--parallax-x) - 40px), calc(var(--parallax-y) - 30px)) scale(0.95);}
  }
  .bg-lines{
    position:absolute;
    top:0;left:0;right:0;bottom:0;
    background-image:linear-gradient(45deg, rgba(0,0,0,0.03) 1px, transparent 1px),
                      linear-gradient(-45deg, rgba(0,0,0,0.03) 1px, transparent 1px);
    background-size:40px 40px;
    z-index:0;
    animation: moveLines 60s linear infinite;
    transform: translate(calc(var(--parallax-x) * -0.3), calc(var(--parallax-y) * -0.3));
  }
  body.dark .bg-lines{
    background-image:linear-gradient(45deg, rgba(255,255,255,0.05) 1px, transparent 1px),
                      linear-gradient(-45deg, rgba(255,255,255,0.05) 1px, transparent 1px);
  }
  @keyframes moveLines{
    from{background-position:0 0, 0 0;}
    to{background-position:200px 200px, -200px -200px;}
  }
  body{display:flex;align-items:flex-start;justify-content:center;padding:24px;z-index:1;}
  .stage{width:100%;max-width:1100px;display:grid;grid-template-columns:1fr 440px;gap:24px;align-items:start;position:relative;z-index:1;}
  .card{
    border-radius:16px;
    background:var(--card-bg);
    border:1px solid rgba(0,0,0,0.05);
    padding:16px;
    box-shadow:0 4px 12px rgba(0,0,0,0.05);
    margin-bottom:16px;
    transition: background 0.5s ease;
  }
  .card:nth-of-type(odd){background:var(--card-odd);}
  .card:nth-of-type(even){background:var(--card-even);}
  .head{
    border-radius:10px;
    padding:6px 12px;
    font-weight:600;
    font-size:13px;
    color:#fff;
    margin:-4px -4px 10px -4px;
    backdrop-filter:blur(10px) saturate(160%);
    -webkit-backdrop-filter:blur(10px) saturate(160%);
  }
  .card:nth-of-type(odd) .head{background:linear-gradient(90deg, rgba(139,92,246,0.9), rgba(236,72,153,0.85));}
  .card:nth-of-type(even) .head{background:linear-gradient(90deg, rgba(236,72,153,0.9), rgba(139,92,246,0.85));}
  .group{margin-bottom:12px;}
  .muted{color:var(--muted);font-size:12px;margin-bottom:4px;display:block;}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:center;}
  input, select{
    width:100%;
    padding:10px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,0.1);
    background:#fff;
    font-size:13px;
    color:var(--text);
  }
  body.dark input, body.dark select{
    background:rgba(255,255,255,0.1);
    border:1px solid rgba(255,255,255,0.15);
    color:#f9fafb;
  }
  input::placeholder{color:rgba(0,0,0,0.4);}
  body.dark input::placeholder{color:rgba(255,255,255,0.5);}
  .btn{
    display:inline-block;
    padding:9px 14px;
    border-radius:12px;
    background:linear-gradient(90deg,var(--accent), var(--accent-alt));
    color:#fff;
    border:none;
    font-weight:600;
    cursor:pointer;
    box-shadow:0 3px 8px rgba(0,0,0,0.1);
    transition:all .2s ease;
    font-size:13px;
  }
  .btn:hover{transform:translateY(-1px);box-shadow:0 6px 12px rgba(0,0,0,0.12)}
  .btn.secondary{background:#fff;color:var(--accent);border:1px solid rgba(0,0,0,0.1);font-weight:600}
  body.dark .btn.secondary{background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.2);}
  .kv{display:grid;grid-template-columns:1fr auto;gap:8px 14px;align-items:center;padding-top:6px;}
  .k{font-size:12px;color:var(--muted);}
  .v{
    font-weight:600;
    font-size:13px;
    color:var(--v-color);
    text-align:right;
    background:var(--v-bg);
    padding:4px 8px;
    border-radius:6px;
    box-shadow:0 1px 2px rgba(0,0,0,0.05);
    display:inline-block;
    transition: background 0.5s ease, color 0.5s ease;
  }
  .v.pop{
    font-size:16px;
    font-weight:700;
    color:#fff;
    background:linear-gradient(90deg,var(--accent), var(--accent-alt));
    padding:6px 10px;
    border-radius:8px;
  }
  .mini{border-radius:12px;padding:10px;background:var(--mini-bg);border:1px solid rgba(0,0,0,0.05);}
  .mini h4{margin:0;font-size:12px;color:var(--muted);}
  .mini .value{font-weight:700;color:var(--text);font-size:14px;margin-top:6px;}
  @media(max-width:980px){.stage{grid-template-columns:1fr;} .card{padding:14px} .head{font-size:12px}}
  /* toggle button */
  
#inputs { display: flex; flex-direction: column; gap: 16px; }
#outputs { display: flex; flex-direction: column; gap: 20px; }

  #toggleMode{
    position:fixed;
    top:20px;
    right:20px;
    padding:8px 12px;
    font-size:12px;
    border-radius:8px;
    background:linear-gradient(90deg,var(--accent), var(--accent-alt));
    color:#fff;
    border:none;
    cursor:pointer;
    z-index:1000;
  }

@media(max-width:600px){
  .card{padding:12px;margin-bottom:12px}
  .head{font-size:12px;padding:4px 8px}
  .kv .k{font-size:11px}
  .kv .v{font-size:12px;padding:3px 6px}
}


#outputs {
  display: flex !important;
  flex-direction: column;
  gap: 20px;
}


#outputs {
  display: flex;
  flex-direction: column;
  gap: 20px;
  margin-top: 20px;
}

</style>

</head>
<body>

<div class='bg-lines'></div>
<div class="stage">
  <!-- INPUTS -->
  <section id="inputs">
  <div>
    <div class="card">
      <div class="head">QUOTATION INPUTS</div>
      <div class="group">
        <label class="muted">List Price (₱)</label>
        <input type="text" value="5,800,000">
      </div>
      <div class="form-grid group">
        <div>
          <label class="muted">Standard Discount (₱ or %)</label>
          <input type="text" placeholder="e.g., 10% or 150000">
        </div>
        <div>
          <label class="muted">Additional Discount (₱ or %)</label>
          <input type="text" placeholder="e.g., 2% or 50000">
        </div>
      </div>
      <div class="form-grid group">
        <div>
          <label class="muted">Special Discount (₱ or %)</label>
          <input type="text" placeholder="e.g., 3% or 75000">
        </div>
        <div>
          <label class="muted">Rebate (₱ or %)</label>
          <input type="text" placeholder="e.g., 1% or 25000">
        </div>
      </div>
      <div class="group">
        <label class="muted">Other Charges (₱)</label>
        <input type="text" placeholder="e.g., 50000">
      </div>
    </div>

    <div class="card">
      <div class="head">PAYMENT TERM INPUTS</div>
      <div class="group">
        <label class="muted">Reservation Fee (₱)</label>
        <input type="text" placeholder="e.g., 30000">
      </div>
      <div class="form-grid group">
        <div>
          <label class="muted">Downpayment %</label>
          <input type="text" placeholder="e.g., 10">
        </div>
        <div>
          <label class="muted">DP Equity %</label>
          <input type="text" placeholder="e.g., 10">
        </div>
      </div>
      <div class="form-grid group">
        <div>
          <label class="muted">No. of Months (Spread)</label>
          <input type="number" placeholder="e.g., 12">
        </div>
        <div>
          <label class="muted">No. of Months (Equity)</label>
          <input type="number" placeholder="e.g., 24">
        </div>
      </div>
      <div style="display:flex;gap:12px;">
        <button class="btn secondary">Spot DP</button>
        <button class="btn secondary">Spread DP</button>
        <button class="btn">Split DP</button>
      </div>
    </div>

    <div class="card">
      <div class="head">BANK FINANCING INPUTS</div>
      <div class="group">
        <label class="muted">Interest Rate % (Annual)</label>
        <input type="text" placeholder="e.g., 7.5">
      </div>
      <div class="group">
        <label class="muted">Loan Term</label>
        <select>
          <option>5 years</option>
          <option>10 years</option>
          <option>15 years</option>
          <option>20 years</option>
        </select>
      </div>
      
    </div>
  </div>

  <div>
    
    <div class="card">
      <div class="head">PROPERTY CONSULTANT INPUTS</div>
      <div class="group">
        <label class="muted">Name</label>
        <input type="text" id="agent_name" placeholder="Enter name">
      </div>
      <div class="group">
        <label class="muted">Mobile No.</label>
        <input type="text" id="agent_mobile" placeholder="Enter mobile number">
      </div>
      <div class="group">
        <label class="muted">Position</label>
        <input type="text" id="agent_pos" placeholder="Enter position">
      </div>
    </div>


    <div class="card">
      <div style="text-align:center; margin-top:14px;">
        <button class="btn">Compute</button>
      </div>
    </div>

  
    <div class="card" style="margin-top:20px">
      <div class="head">PROPERTY CONSULTANT</div>
      <div class="kv">
        <div class="k">Name</div><div class="v" id="s_agent_name">—</div>
        <div class="k">Mobile No.</div><div class="v" id="s_agent_mobile">—</div>
        <div class="k">Position</div><div class="v" id="s_agent_pos">—</div>
      </div>
    </div>

</section>

  <!-- OUTPUTS -->
  
</div>

<script>
document.addEventListener("mousemove", (e) => {
  const { innerWidth, innerHeight } = window;
  const x = (e.clientX / innerWidth - 0.5) * 30; 
  const y = (e.clientY / innerHeight - 0.5) * 30;

  document.body.style.setProperty("--parallax-x", `${x}px`);
  document.body.style.setProperty("--parallax-y", `${y}px`);
});
</script>


<script>
document.addEventListener("DOMContentLoaded",()=>{
  const btn=document.createElement("button");
  btn.id="toggleMode";
  btn.innerText="Toggle Mode";
  document.body.appendChild(btn);
  btn.addEventListener("click",()=>{
    document.body.classList.toggle("dark");
  });
});
</script>



<!-- Computation Logic from index.html -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js">
function addDivider(ptKV) {
  const hr = document.createElement('hr');
  hr.style.gridColumn = "1 / -1";
  hr.style.border = "0";
  hr.style.borderTop = "1px solid #999";
  hr.style.margin = "6px 0";
  ptKV.append(hr);
}
</script>
<script>
// helper: round to 2 decimals like Excel
function r2(x){ return Math.round((x + Number.EPSILON)*100)/100; }

// ===== Helpers =====
const peso = n => {
  if(!isFinite(n)) return '—';
  return '₱' + (Math.round((n + Number.EPSILON)*100)/100).toLocaleString('en-PH', {minimumFractionDigits:2, maximumFractionDigits:2});
};

// Helper: format value with optional % label
function formatWithPct(amount, raw) {
  if (!raw) return peso(amount);
  raw = raw.toString().trim();
  if (/%$/.test(raw)) {
    return peso(amount) + " (" + raw + ")";
  }
  return peso(amount);
}
const readNum = el => {
  const v = (document.getElementById(el).value || '').toString().replace(/,/g,'');
  const n = parseFloat(v);
  return isNaN(n) ? 0 : n;
};
const readTxt = el => (document.getElementById(el).value || '').trim();
const isPercent = v => /%$/.test(v.trim());
const parseValue = (raw, baseForPercent=0) => {
  if(!raw) return {amount:0, isPct:false, raw:''};
  const s = raw.toString().trim();
  if(s.length===0) return {amount:0, isPct:false, raw:''};
  if(isPercent(s)){
    const p = parseFloat(s.replace('%','').trim());
    const amt = isFinite(p) ? (baseForPercent * (p/100)) : 0;
    return {amount:amt, isPct:true, pct:(isFinite(p)?p:0), raw:s};
  }else{
    const amt = parseFloat(s.replace(/[^0-9.\-]/g,''));
    return {amount:isNaN(amt)?0:amt, isPct:false, raw:s};
  }
};

// Sequential discount on a running base
function applyDiscountsSequential(listPrice, entries){
  // entries = array of {raw: '10%' or '20000'}
  let base = listPrice;
  const out = [];
  for(const ent of entries){
    const parsed = parseValue(ent, base); // % uses CURRENT base
    const discAmt = Math.min(base, Math.max(0, parsed.amount));
    base = base - discAmt;
    out.push({label: ent.label, amount: discAmt, raw: ent});
  }
  return {net: Math.max(0, base), details: out};
}

// ===== Payment term visibility =====
const termButtons = document.getElementById('termButtons');
let currentTerm = 'spot';
termButtons.addEventListener('click', (e)=>{
  if(e.target.tagName!=='BUTTON') return;
  [...termButtons.children].forEach(b=>b.classList.remove('active'));
  e.target.classList.add('active');
  currentTerm = e.target.dataset.term;
  document.getElementById('fields_spot').classList.toggle('hidden', currentTerm!=='spot');
  document.getElementById('fields_spread').classList.toggle('hidden', currentTerm!=='spread');
  document.getElementById('fields_split').classList.toggle('hidden', currentTerm!=='split');
});

// ===== Compute main =====
document.getElementById('btnCompute').addEventListener('click', ()=>{
  const listPrice = readNum('price_list');

  // Discounts (successive)
  const dStd = readTxt('disc_std');
  const dSpecial = readTxt('disc_special');
  const dAdd = readTxt('disc_add');
  const dReb = readTxt('disc_rebate');
  const discs = [
    {label:'Standard Discount', value: dStd},
    {label:'Special Discount', value: dSpecial},
    {label:'Additional Discount', value: dAdd},
    {label:'Rebate', value: dReb}
  ];
  const discApplied = applyDiscountsSequential(listPrice, discs.map(d=>({label:d.label, toString:()=>d.value, value:d.value, raw:d.value})));
  const netList = discApplied.net;

  // Other charges (either % or ₱) on Net List
  const ocParsed = parseValue(readTxt('other_charges'), netList);
  const otherCharges = Math.max(0, ocParsed.amount);

  // VAT 12% if (netList + otherCharges) > 3.6M, else 0
  const vatBase = netList + otherCharges;
  const vat = (vatBase > 3600000) ? (vatBase * 0.12) : 0;

  const TAP = netList + otherCharges + vat;

  // ----- Payment term computations -----
  let dp = 0, netDP = 0, dpEquity = 0, months = 0, monthly = 0, remaining = 0;

  if(currentTerm==='spot'){
    const pct = readNum('spot_dp_pct')/100;
    const rf  = readNum('spot_rf');
    months = Math.max(0, Math.floor(readNum('spot_months'))||0);
    dp = r2(TAP * (isFinite(pct)?pct:0));
    netDP = r2(Math.max(0, dp - rf));
    remaining = Math.max(0, TAP - (dp + dpEquity));
    monthly = (months>0) ? r2(netDP / months) : 0; // optional display if user provided months
  }
  if(currentTerm==='spread'){
    const pct = readNum('spread_dp_pct')/100; // equity
    const rf  = readNum('spread_rf');
    months = Math.max(1, Math.floor(readNum('spread_months'))||0);
    dp = r2(TAP * (isFinite(pct)?pct:0)); // DP (equity)
    netDP = r2(Math.max(0, dp - rf));
    dpEquity = dp;
    monthly = (months>0) ? r2(netDP / months) : 0;
    remaining = Math.max(0, TAP - (dp + dpEquity));
  }
  if(currentTerm==='split'){
    const pctDP = readNum('split_dp_pct')/100;
    const rf  = readNum('split_rf');
    const pctEq = readNum('split_equity_pct')/100;
    months = Math.max(1, Math.floor(readNum('split_months'))||0);
    dp = r2(TAP * (isFinite(pctDP)?pctDP:0));
    netDP = r2(Math.max(0, dp - rf));
    dpEquity = r2(TAP * (isFinite(pctEq)?pctEq:0));
    monthly = (months>0) ? r2(dpEquity / months) : 0;
    remaining = Math.max(0, TAP - (dp + dpEquity));
  }

  // ----- Bank financing (on remaining balance) -----
  const interest = readNum('bank_interest');
  function amort(p, annualPct, years){
    if(p<=0 || annualPct<=0 || years<=0) return 0;
    const i = (annualPct/100)/12;
    const n = years*12;
    const f = Math.pow(1+i, n);
    return p * (i * f) / (f - 1);
  }
  const b5  = amort(remaining, interest, 5);
  const b10 = amort(remaining, interest, 10);
  const b15 = amort(remaining, interest, 15);
  const b20 = amort(remaining, interest, 20);

  // ===== Populate Summary =====
  const set = (id, val) => document.getElementById(id).textContent = val;

  // Project details
  set('s_pd_project',   readTxt('pd_project') || '—');
  set('s_pd_tower',     readTxt('pd_tower') || '—');
  set('s_pd_unittype',  readTxt('pd_unittype') || '—');
  set('s_pd_unitno',    readTxt('pd_unitno') || '—');
  set('s_pd_floor',     readTxt('pd_floor') || '—');
  set('s_pd_view',      readTxt('pd_view') || '—');

  // Pricing
  set('v_listprice', peso(listPrice));

  // Discounts: hide empty
  const rows = [
    ['row_std_k','row_std_v', discApplied.details[0]?.amount || 0],
    ['row_special_k','row_special_v', discApplied.details[1]?.amount || 0],
    ['row_add_k','row_add_v', discApplied.details[2]?.amount || 0],
    ['row_rebate_k','row_rebate_v', discApplied.details[3]?.amount || 0]
  ];
  rows.forEach(([k,v,amt], i)=>{
    const show = amt > 0.0001;
    const rowId = ['row_std','row_special','row_add','row_rebate'][i];
    const rowEl = document.getElementById(rowId);
    if (rowEl) rowEl.style.display = show ? 'contents' : 'none';
    set(v, show ? ('- ' + formatWithPct(amt, discs[i].value)) : '');
});

  set('v_netlist', peso(netList));

  // --- Other Charges row (always visible, keep grid alignment) ---
set('row_other_v', '+ ' + formatWithPct(otherCharges, readTxt('other_charges')));

// --- VAT row (always visible, with 3.6M rule, aligned in grid) ---
if (vatBase <= 3600000) {
  document.getElementById('row_vat_k').textContent = 'VAT (0% – ₱3.6M rule)';
} else {
  document.getElementById('row_vat_k').textContent = 'VAT (12%)';
}
set('row_vat_v', '+ ' + formatWithPct(vat, vatBase <= 3600000 ? '0%' : '12%'));
set('v_tap', peso(TAP));

  // Payment term section (dynamic rows)
  const ptKV = document.getElementById('ptKV');
  ptKV.innerHTML = ''; // reset
  function addRow(k, v, emphasize=false){
    const dk = document.createElement('div'); dk.className='k'+(emphasize?' em':'');
    dk.textContent = k;
    const dv = document.createElement('div'); dv.className='v'+(emphasize?' em':'');
    dv.textContent = v;
    ptKV.append(dk, dv);
  }
  if(currentTerm==='spot'){
    addRow('Plan', 'Spot DP (Cash)');
    addRow('Downpayment', formatWithPct(dp, document.getElementById(currentTerm==='spot'?'spot_dp_pct':(currentTerm==='spread'?'spread_dp_pct':'split_dp_pct')).value), true);
    addRow('Reservation Fee', '- ' + peso(readNum('spot_rf')), true);
    
        var spreadMonths = readNum("split_spread_months");
        if(spreadMonths > 0){
            addRow("Net Downpayment", peso(netDP), true);
            addRow("Spread In (Months)", spreadMonths.toString());
            var monthlySpread = (netDP / spreadMonths);
            addRow("Monthly Amortization", peso(monthlySpread), true);
            (function(){
                var div = document.createElement('div');
                div.className = 'divider';
                ptKV.append(div);
            })();
        } else {
            addRow("Net Downpayment", peso(netDP), true);
        }
        
    if(months>0){ addRow('No. of Months', months.toString()); addRow('Monthly Amortization', peso(monthly), true); }
    addRow('Remaining Balance', formatWithPct(remaining, ((remaining>0&&TAP>0)?((remaining/TAP*100).toFixed(2)+'%'):'0%')), true);
  }
  if(currentTerm==='spread'){
    addRow('Plan', 'Spread DP (Preselling)');
    addRow('Downpayment (Equity)', formatWithPct(dpEquity, document.getElementById(currentTerm==='split'?'split_equity_pct':'spread_dp_pct').value), true);
    addRow('Reservation Fee', '- ' + peso(readNum('spread_rf')), true);
    
        var spreadMonths = readNum("split_spread_months");
        if(spreadMonths > 0){
            addRow("Net Downpayment", peso(netDP), true);
            addRow("Spread In (Months)", spreadMonths.toString());
            var monthlySpread = (netDP / spreadMonths);
            addRow("Monthly Amortization", peso(monthlySpread), true);
            (function(){
                var div = document.createElement('div');
                div.className = 'divider';
                ptKV.append(div);
            })();
        } else {
            addRow("Net Downpayment", peso(netDP), true);
        }
        
    addRow('No. of Months', (months||0).toString());
    addRow('Monthly Amortization', peso(monthly), true);
    addRow('Remaining Balance', formatWithPct(remaining, ((remaining>0&&TAP>0)?((remaining/TAP*100).toFixed(2)+'%'):'0%')), true);
  }
  if(currentTerm==='split'){
    addRow('Plan', 'Split DP');
    addRow('Downpayment', formatWithPct(dp, document.getElementById(currentTerm==='spot'?'spot_dp_pct':(currentTerm==='spread'?'spread_dp_pct':'split_dp_pct')).value), true);
    addRow('Reservation Fee', '- ' + peso(readNum('split_rf')), true);
    
        var spreadMonths = readNum("split_spread_months");
        if(spreadMonths > 0){
            addRow("Net Downpayment", peso(netDP), true);
            addRow("Spread In (Months)", spreadMonths.toString());
            var monthlySpread = (netDP / spreadMonths);
            addRow("Monthly Amortization", peso(monthlySpread), true);
            (function(){
                var div = document.createElement('div');
                div.className = 'divider';
                ptKV.append(div);
            })();
        } else {
            addRow("Net Downpayment", peso(netDP), true);
        }
        
    addRow('Downpayment (Equity)', formatWithPct(dpEquity, document.getElementById(currentTerm==='split'?'split_equity_pct':'spread_dp_pct').value), true);
    addRow('No. of Months', (months||0).toString());
    addRow('Monthly Amortization', peso(monthly), true);
    addRow('Remaining Balance', formatWithPct(remaining, ((remaining>0&&TAP>0)?((remaining/TAP*100).toFixed(2)+'%'):'0%')), true);
  }

  // Bank section (hide if no interest or remaining=0)
  const showBank = (interest>0 && remaining>0);
  document.getElementById('cardBank').style.display = showBank ? 'block' : 'none';
  set('v_interest', interest>0 ? (interest.toFixed(2) + '%') : '—');
  set('v_b5',  b5 ? peso(b5)  : '—');
  set('v_b10', b10? peso(b10) : '—');
  set('v_b15', b15? peso(b15) : '—');
  set('v_b20', b20? peso(b20) : '—');

  // Agent
  set('s_agent_name',  readTxt('agent_name')  || '—');
  set('s_agent_mobile',readTxt('agent_mobile')|| '—');
  set('s_agent_pos',   readTxt('agent_pos')   || '—');

  // Toggle views
  document.getElementById('inputView').style.display = 'none';
  document.getElementById('summaryView').style.display = 'block';
  setTimeout(()=>document.getElementById('summaryView').classList.add('show'),25);

  // Date
  const d = new Date();
  document.getElementById('genDate').textContent = d.toLocaleDateString('en-PH', {year:'numeric', month:'short', day:'2-digit'});
});

document.getElementById('btnBack').addEventListener('click', ()=>{
  document.getElementById('summaryView').classList.remove('show');
  document.getElementById('summaryView').style.display = 'none';
  document.getElementById('inputView').style.display = 'block';
});


function enableScreenshotMode() {
  document.body.classList.add("screenshot-mode");
}


// --- Bank Financing Amortization Computation ---
function computeBankAmortizations(balance, annualRate) {
  const card = document.getElementById("bankAmortCard");
  if (!card) return;
  const rate = parseFloat(annualRate) / 100.0;
  document.getElementById("bankInterestUsed").innerText = (rate*100).toFixed(2) + "% per annum";

  const terms = [5, 10, 15, 20];
  terms.forEach(function(years) {
    const n = years * 12;
    const r = rate / 12;
    let monthly = 0;
    if (r > 0) {
      monthly = (balance * r) / (1 - Math.pow(1 + r, -n));
    } else {
      monthly = balance / n;
    }
    document.getElementById("amort" + years).innerText = monthly.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
  });
  card.style.display = "block";
}


// After computing, adjust labels to include % where applicable
document.querySelectorAll('#row_std, #row_special, #row_add, #row_rebate').forEach(function(row) {
  var inputId = row.id.replace('row_','disc_');
  var val = document.getElementById(inputId).value;
  if(val && /%$/.test(val.trim())) {
    var k = row.querySelector('.k');
    if(k && !k.querySelector('.pct-label')) {
      k.innerHTML = k.textContent + ' <span class="pct-label">('+val+')</span>';
    }
  }
});
var oc = document.getElementById('other_charges').value;
if(oc && /%$/.test(oc.trim())) {
  var k = document.querySelector('#row_other_v').previousElementSibling;
  if(k && !k.querySelector('.pct-label')) {
    k.innerHTML = 'Other Charges <span class="pct-label">('+oc+')</span>';
  }
}
var vatBase = netList + otherCharges;
if(vatBase <= 3600000) {
  document.getElementById('row_vat_k').innerHTML = 'VAT <span class="pct-label">(0%)</span> – ₱3.6M rule';
} else {
  document.getElementById('row_vat_k').innerHTML = 'VAT <span class="pct-label">(12%)</span>';
}
// Payment Term Details
if(currentTerm) {
  var dpPct = document.getElementById(currentTerm==='spot'?'spot_dp_pct':(currentTerm==='spread'?'spread_dp_pct':'split_dp_pct')).value;
  if(dpPct) {
    var lbl = document.querySelector('#ptKV .k:contains("Downpayment")');
  }
}


setTimeout(hideEmptyRows,0);</script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".summary-row").forEach(row => {
        let valueCell = row.querySelector(".summary-value");
        if (valueCell && (valueCell.textContent.trim() === "" || valueCell.textContent.trim() === "₱0.00")) {
            row.classList.add("hidden");
        }
    });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const exempt = ['price_list', 'disc_std', 'disc_special', 'disc_add', 'disc_rebate', 'other_charges', 'spot_rf', 'spread_rf', 'split_rf', 'bank_interest', 'agent_mobile'];
  document.querySelectorAll("input").forEach(el => {
    el.addEventListener("input", function(e) {
      if (exempt.includes(el.id)) return; // skip formatting for exempted IDs
    });
  });
});
</script>
<script>
// Safe input formatting: only format a small set of numeric fields on blur; do not modify value while typing.
(function(){
  const numericIds = ['price_list','spot_rf','spread_rf','split_rf',
                      'spot_months','spread_months','split_months','bank_interest'];
  function cleanForParse(v){
    if(v === null || v === undefined) return '';
    return String(v).replace(/[,₱\s]/g, '').replace(/[^\d.]/g, '');
  }
  function addCommasToInteger(str){
    return String(str).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  }
  numericIds.forEach(id => {
    const el = document.getElementById(id);
    if(!el) return;
    // On focus: remove commas to make editing easier
    el.addEventListener('focus', function(e){
      this.dataset.prev = this.value;
      this.value = String(this.value).replace(/,/g,'');
    });
    // On blur: clean non-numeric (except dot), then format integer part with commas
    el.addEventListener('blur', function(e){
      const raw = this.value || '';
      const cleaned = cleanForParse(raw);
      if(cleaned === '') { this.value = ''; return; }
      if(cleaned.indexOf('.') > -1){
        const parts = cleaned.split('.');
        const intPart = parts[0] || '0';
        const decPart = parts[1] || '';
        this.value = addCommasToInteger(intPart) + (decPart ? '.' + decPart : '');
      } else {
        this.value = addCommasToInteger(cleaned);
      }
    });
    // Intentionally do NOT modify value on input to avoid blocking typing
  });
})();
</script>
<script defer="">
// Safe input formatting: numeric formatting only for certain fields; allow free typing in Project Details & Consultant fields.
(function(){
  const numericIds = ['price_list','spot_rf','spread_rf','split_rf',
                      'spot_months','spread_months','split_months','bank_interest'];
  const freeIds = ['pd_project','pd_tower','pd_unittype','pd_unitno','pd_floor','pd_view',
                   'agent_name','agent_mobile','agent_pos'];
  function cleanForParse(v){
    if(v === null || v === undefined) return '';
    return String(v).replace(/[,₱\s]/g, '').replace(/[^\d.]/g, '');
  }
  function addCommasToInteger(str){
    return String(str).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  }
  numericIds.forEach(id => {
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('focus', function(e){
      this.value = String(this.value).replace(/,/g,'');
    });
    el.addEventListener('blur', function(e){
      const raw = this.value || '';
      const cleaned = cleanForParse(raw);
      if(cleaned === '') { this.value = ''; return; }
      if(cleaned.indexOf('.') > -1){
        const parts = cleaned.split('.');
        const intPart = parts[0] || '0';
        const decPart = parts[1] || '';
        this.value = addCommasToInteger(intPart) + (decPart ? '.' + decPart : '');
      } else {
        this.value = addCommasToInteger(cleaned);
      }
    });
  });
  // freeIds: no formatting, just allow free typing, so no event listeners
})();
</script>
<script>
function hideEmptyRows(){
    document.querySelectorAll('#summaryView .kv').forEach(function(row){
        var v = row.querySelector('.v');
        if(v && (!v.textContent.trim() || v.textContent.trim()==='₱0.00' || v.textContent.trim()==='0')){
            row.style.display = 'none';
        } else {
            row.style.display = '';
        }
    });
}
</script>
<script>
function saveQuotationImage(){
    html2canvas(document.getElementById("summaryView")).then(canvas => {
        var link = document.createElement("a");
        link.download = "quotation.png";
        link.href = canvas.toDataURL();
        link.click();
    });
}
document.getElementById("btnSave").onclick = saveQuotationImage;
</script>
<script>
document.addEventListener("DOMContentLoaded", function(){
  const computeBtn = document.querySelector("#inputs .btn"); 
  if(computeBtn){
    computeBtn.addEventListener("click", function(){
      document.getElementById("outputs").style.display = "flex";
    });
  }
});
</script>
</body>
</html>